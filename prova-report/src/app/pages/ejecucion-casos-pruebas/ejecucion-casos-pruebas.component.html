<div>
  <div class="banner">
    <button *ngIf="testCaseSelected != null" class="back-button" nz-button nzType="text" (click)="backtestCase()">
      <i nz-icon nzType="left" nzTheme="outline" (click)="backtestCase()"></i>
    </button>
    <span>Ejecucion Casos Pruebas</span>
  </div>
  <form [hidden]="nivelPositionTest > 0" [formGroup]="filterFormGroup">
    <div class="row d-flex">
      <div class="col-md-3">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Proyectos</mat-label>
          <mat-select formControlName="projects" (selectionChange)="updateFilter($event)">
            <mat-option *ngFor="let pro of listProjects" [value]="pro.key">
              {{ pro.value }}
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="validaciones('projects')" class="form-text text-danger animate__animated animate__headShake">
            Seleccione uno</mat-hint>
        </mat-form-field>
      </div>

      <div class="col-md-3">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Test Suite</mat-label>
          <mat-select formControlName="testSuite" (selectionChange)="updateFilter($event)">
            <mat-option *ngFor="let tSuite of listTestSuite" [value]="tSuite.key">
              {{ tSuite.value }}
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="validaciones('testSuite')"
            class="form-text text-danger animate__animated animate__headShake">Seleccione uno</mat-hint>
        </mat-form-field>
      </div>

      <div class="col-md-3">
        <button mat-flat-button color="primary" class="button-global ps-3 pe-3 iconify-mright"
          style="margin-top: 0.5rem" (click)="search()">
          <span class="iconify" data-icon="charm:paper-plane" style="color: white" data-width="24"
            data-height="24"></span>
          <span>Aplicar Filtros</span>
        </button>
      </div>
    </div>
  </form>

  <div [hidden]="
      (listTestCase.length == 0 && nivelPositionTest == 0) ||
      testCaseSelected != null
    " style="margin-top: 3rem">
    <div class="col-12">
      <mat-form-field appearance="outline" class="w-100 filter-table">
        <mat-icon matSuffix>search</mat-icon>
        <mat-label>Filtrar por Título, Descripcion, Estado, Prioridad, Responsable o
          Registrado Por</mat-label>
        <input matInput autocomplete="off" (keyup)="filterTableTestCase($event)" #inputFilter />
      </mat-form-field>
    </div>
    <table mat-table class="table-hover" [dataSource]="dataSourceTestCase" #sort matSort style="width: 100%">
      
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>Id</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          #{{ element.id }}
        </td>
      </ng-container>

      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>Título</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          {{ element.title }}
        </td>
      </ng-container>

      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef>Descripción</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          {{ element.description }}
        </td>
      </ng-container>

      <ng-container matColumnDef="state">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          <span [ngClass]="{
            'test-state-passed': element.testState.name == 'Superado',
            'test-state-non-executed': element.testState.name == 'No ejecutado',
            'test-state-skipped': element.testState.name == 'Omitido',
            'test-state-failed': element.testState.name == 'Fallido'
          }">{{ element.testState.name }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef>Prioridad</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          {{ element.priority.name }}
        </td>
      </ng-container>

      <ng-container matColumnDef="severity">
        <th mat-header-cell *matHeaderCellDef>Severidad</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          {{ element.severity.name }}
        </td>
      </ng-container>

      <ng-container matColumnDef="registerDate">
        <th mat-header-cell *matHeaderCellDef>Fecha de Registro</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          {{ element.createdAt }}
        </td>
      </ng-container>

      <ng-container matColumnDef="responsable">
        <th mat-header-cell *matHeaderCellDef>Responsable</th>
        <td mat-cell *matCellDef="let element" (click)="enterTestCase(element)">
          {{ element.userInCharge.firstName }}
          {{ element.userInCharge.lastName }}
        </td>
      </ng-container>

      <ng-container matColumnDef="opciones">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element">
          <button class="details" nz-button nzType="primary" (click)="detailsExecutionTestCase(element.id)">
            <i nz-icon nzType="profile" nzTheme="outline"></i>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="headerColumn"></tr>
      <tr mat-row *matRowDef="let row; columns: headerColumn"></tr>
      <tr class="mat-row text-center" *matNoDataRow>
        <td *ngIf="inputFilter.value == ''" class="mat-cell" colspan="3">
          No se encontraron casos de prueba <i class="bi bi-journals"></i>
        </td>
        <td *ngIf="inputFilter.value != ''" class="mat-cell" colspan="3">
          No hay registros con el valor: "{{ inputFilter.value }}"
          <i class="bi bi-journals"></i><i class="bi bi-search"></i>
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 15, 20]" showFirstLastButtons #paginator></mat-paginator>
  </div>

  <div class="col-12 centerItems" style="margin-top: 3rem" *ngIf="listTestCase.length == 0 && nivelPositionTest == 0">
    <div style="width: 50%; overflow: hidden; text-align: center">
      <div>
        <mat-icon class="NoTest" svgIcon="NoTest"></mat-icon>
      </div>
      <div class="text-w-bold text-fs-32 text-purple title-table-photo text-center">
        Selecciona tus filtros
      </div>
      <div class="text-w-400 text-fs-14 text-center text-gray">
        Para poder mostrarte los Casos de Prueba a ejecutar
      </div>
    </div>
  </div>

  <div class="col-12" *ngIf="testCaseSelected != null">
    <div class="row" style="margin-left: 2rem">
      <div class="col-6">
        <div>
          <span class="iconify" data-icon="teenyicons:ab-testing-solid" data-width="24" data-height="24"
            style="color: #03dac5"></span>
          <span class="text-fs-24 text-w-bold" style="margin-left: 12px">Suite: </span><span class="text-fs-20">{{
            testCaseSelected.testSuite.title
            }}</span>
        </div>
      </div>
      <div class="col-6">
        <div>
          <span class="iconify" data-icon="emojione-v1:open-folder" data-width="24" data-height="24"></span>
          <span class="text-fs-24 text-w-bold" style="margin-left: 12px">Formato de Carga
          </span>
          <button mat-flat-button color="primary" class="button-global ps-3 pe-3 iconify-mright"
            style="margin-left: 2rem">
            <span class="iconify" data-icon="ant-design:download-outlined" style="color: white" data-width="24"
              data-height="24"></span>
            <span>Descargar</span>
          </button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-left: 2rem; margin-top: 2rem; margin-right: 2rem">
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Caso de prueba:
        </span>
        <span class="text-fs-20">
          #{{ testCaseSelected.id }}
        </span>
      </div>
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Titulo:
        </span>
        <span class="text-fs-20">
          {{ testCaseSelected.title }}
        </span>
      </div>
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Descripcion:
        </span>
        <span class="text-fs-20">
          {{ testCaseSelected.description }}
        </span>
      </div>
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Estado:
        </span>
        <span class="text-fs-20">
          {{ testCaseSelected.testState.name }}
        </span>
      </div>
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Prioridad:
        </span>
        <span class="text-fs-20">
          {{ testCaseSelected.priority.name }}
        </span>
      </div>
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Severidad:
        </span>
        <span class="text-fs-20">
          {{ testCaseSelected.severity.name }}
        </span>
      </div>
      <div class="col">
        <span class="text-fs-24 text-w-bold col-12" style="margin-bottom: 1rem">Responsable:
        </span>
        <span class="text-fs-20">
          {{ testCaseSelected.userInCharge.firstName }}
          {{ testCaseSelected.userInCharge.lastName }}
        </span>
      </div>
    </div>
    <form [formGroup]="formulario" (ngSubmit)="enviarEjecucion()">
      <div class="fileSection" style="margin-left: 2.5rem; margin-top: 2rem; margin-right: 2rem">
        <div>
          <div class="row">
            <div>
              <mat-label class="text-fs-24 text-w-bold col-12">Carga de Archivo</mat-label>
            </div>
            <div [class.noFileUploadBackground]="file == null" [class.fileUploadBackground]="file != null" class="w-75">
              <div class="text-center" style="margin-bottom: 1.5rem; margin-top: 1.5rem">
                <div *ngIf="file == null">
                  <span class="iconify" data-icon="fa-solid:file-upload" data-width="85px" data-height="95px"
                    style="color: #ff8585"></span>
                </div>
                <div *ngIf="file != null">
                  <span class="iconify" data-icon="fa-solid:file-upload" data-width="85px" data-height="95px"
                    style="color: #a2ff85"></span>
                </div>

                <div *ngIf="file != null" class="filePrev">
                  <div>
                    <span class="iconify" data-icon="akar-icons:file" data-width="24px" data-height="24px"
                      style="color: #00f1b2"></span>
                  </div>
                  <div>
                    <h4>
                      {{ file?.name }}
                    </h4>
                  </div>
                  <button mat-flat-button color="primary" class="button-global ps-3 pe-3 iconify-mright"
                    (click)="deleteFile()">
                    <span class="iconify" data-icon="ant-design:delete-filled" data-width="24px" data-height="24px"
                      style="color: #f10000"></span>
                  </button>
                </div>
              </div>
              <div *ngIf="file == null" class="text-center">
                <span class="text-fs-16 text-black">Solo se permiten archivos en formato XML</span><br />
                <input #FileClick id="FileClick" type="file" style="display: none" (change)="fileChanged($event)" />
                <a href="javascript:void(0)" (click)="FileClick.click()" for="FileClick">Busca en tu ordenador</a>
              </div>
            </div>
          </div>
        </div>

        <div>
          <mat-label class="text-fs-24 text-w-bold col-12">Comentarios</mat-label>
          <mat-form-field appearance="outline" style="width: 100%; margin-top: 0.7rem">
            <mat-label>Ingresa tu comentario</mat-label>
            <textarea matInput style="height: 121px; resize: none" placeholder="Ingresa tu comentario"
              formControlName="commentary">
            </textarea>
          </mat-form-field>

          <div class="iconify-mright">
            <mat-label class="text-fs-24 text-w-bold col-12" style="margin-right: 1rem">Reporte Bugs</mat-label>
            <mat-icon class="BugIcon" svgIcon="BugIcon" style="color: #5afe73"></mat-icon>
            <button mat-flat-button color="primary" class="button-global ps-3 pe-3 iconify-mright"
              style="margin-left: 2rem">
              <span class="iconify" data-icon="ant-design:plus-circle-filled" style="color: white" data-width="24"
                data-height="24"></span>
              <span>Reportar Bug</span>
            </button>
          </div>
        </div>
      </div>

      <div style="margin-left: 3rem">
        <mat-label class="text-fs-24 text-w-bold col-12">Test Steps</mat-label>
        <div [hidden]="listTestCaseSteps.length == 0">
          <table mat-table class="table-hover" style="width: 100%" [dataSource]="dataSourceTestSteps">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Título</th>
              <td mat-cell *matCellDef="let element">
                {{ element.name }}
              </td>
            </ng-container>
            <ng-container matColumnDef="executed_by">
              <th mat-header-cell *matHeaderCellDef>Ejecutado por</th>
              <td mat-cell *matCellDef="let element">
                {{ element.created_by }}
              </td>
            </ng-container>
            <ng-container matColumnDef="start_time">
              <th mat-header-cell *matHeaderCellDef>Tiempo Inicio</th>
              <td mat-cell *matCellDef="let element">
                {{ element.start_time }}
              </td>
            </ng-container>
            <ng-container matColumnDef="end_time">
              <th mat-header-cell *matHeaderCellDef>Tiempo Fin</th>
              <td mat-cell *matCellDef="let element">
                {{ element.end_time }}
              </td>
            </ng-container>
            <ng-container matColumnDef="duration">
              <th mat-header-cell *matHeaderCellDef>Duración</th>
              <td mat-cell *matCellDef="let element">
                {{ utils.formatTime(element.duration) }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="headerColumnTestCaseSteps"></tr>
            <tr mat-row *matRowDef="let row; columns: headerColumnTestCaseSteps"></tr>
            <tr class="mat-row text-center" *matNoDataRow>
              <td class="mat-cell" colspan="3">
                No se encontraron TestSteps <i class="bi bi-journals"></i>
              </td>
            </tr>
          </table>
          <mat-paginator id="paginatorTestCase" [pageSizeOptions]="[5, 10, 15, 20]" showFirstLastButtons
            #paginatorTestCase></mat-paginator>
        </div>
        <div *ngIf="listTestCaseSteps.length == 0" class="col-12 centerItems"
          style="margin-top: 3rem; margin-bottom: 2rem">
          <div style="width: 50%; overflow: hidden; text-align: center">
            <div>
              <mat-icon class="NoTest" svgIcon="NoTest"></mat-icon>
            </div>
            <div class="text-w-bold text-fs-32 text-purple title-table-photo text-center">
              Registra una Ejecucion
            </div>
            <div class="text-w-400 text-fs-14 text-center text-gray">
              Para poder mostrarte los pasos de la última ejecución
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex flex-row-reverse">
        <button mat-flat-button color="primary" class="button-global ps-3 pe-3 iconify-mright">
          <span class="iconify" data-icon="ant-design:plus-circle-filled" style="color: white" data-width="24"
            data-height="24"></span>
          <span>Cargar Ejecución</span>
        </button>
      </div>
    </form>
  </div>
</div>